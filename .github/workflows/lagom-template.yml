name: Lagom Template

on:
  workflow_call:
    inputs:
      toolchain:
        required: true
        type: string
      os_name:
        required: true
        type: string
      runner_labels:
        required: true
        type: string
      arch:
        required: true
        type: string
      build_preset:
        required: true
        type: string
      clang_plugins:
        required: false
        type: boolean
        default: false

env:
  # runner.workspace = /home/runner/work/ladybird
  # github.workspace = /home/runner/work/ladybird/ladybird
  LADYBIRD_SOURCE_DIR: ${{ github.workspace }}
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  VCPKG_ROOT: ${{ github.workspace }}/Build/vcpkg

  # Use the compiler version for the ccache compiler hash. Otherwise, if plugins are enabled, the plugin .so files
  # are included in the hash. This results in clean builds on every run as the .so files are rebuilt.
  #
  # Note: This only works because our plugins do not transform any code. If that becomes untrue, we must revisit this.
  CCACHE_COMPILERCHECK: "%compiler% -v"

jobs:
  CI:
    runs-on: ${{ fromJSON(inputs.runner_labels) }}

    steps:
      # Pull requests can trail behind `master` and can cause breakage if merging before running the CI checks on an updated branch.
      # Luckily, GitHub creates and maintains a merge branch that is updated whenever the target or source branch is modified. By
      # checking this branch out, we gain a stabler `master` at the cost of reproducibility.
      - uses: actions/checkout@v6
        if: ${{ github.event_name != 'pull_request' }}

      - uses: actions/checkout@v6
        if: ${{ github.event_name == 'pull_request' }}
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      # ---- Ensure system build tools are present on Linux runners ----
      # IMPORTANT: this runs before "Set Up Environment" so any setup action that triggers CMake/vcpkg
      # will see the required tools (ninja, compilers, nasm, etc.).
      - name: Install or verify system build dependencies (Linux)
        if: ${{ inputs.os_name == 'Linux' }}
        env:
          TOOLCHAIN: ${{ inputs.toolchain }}
        run: |
          set -euo pipefail

          echo "Installing/verifying build deps for toolchain: $TOOLCHAIN"
          echo "Diagnostics: uname / /etc/os-release / user"
          uname -a || true
          if [ -f /etc/os-release ]; then cat /etc/os-release || true; fi
          echo "User: $(id -un || true)  UID: $(id -u || true)"
          echo "sudo available: $(command -v sudo >/dev/null 2>&1 && echo yes || echo no)"
          echo "apt-get available: $(command -v apt-get >/dev/null 2>&1 && echo yes || echo no)"

          # If apt-get present and we can run sudo (or we're root), perform install.
          if command -v apt-get >/dev/null 2>&1; then
            if sudo -n true >/dev/null 2>&1; then
              SUDO='sudo'
            elif [ "$(id -u)" -eq 0 ]; then
              SUDO=''
            else
              echo "No passwordless sudo and not root. Cannot apt-install packages from this runner."
              echo "This is likely a self-hosted runner that needs the build dependencies preinstalled."
              echo ""
              echo "Required packages (Ubuntu/Debian):"
              echo "  sudo apt-get update"
              echo "  sudo apt-get install -y ninja-build build-essential pkg-config ca-certificates curl nasm yasm linux-libc-dev mesa-common-dev"
              echo "Also install requested toolchain packages (example): gcc-14 g++-14 or clang-20"
              echo ""
              echo "Failing early so CI logs show this explicit message."
              exit 1
            fi

            echo "Installing via: $SUDO apt-get"
            $SUDO apt-get update -y
            # Include nasm and yasm (libvpx needs nasm), linux-libc-dev (for openssl), mesa-common-dev (for angle) etc.
            $SUDO DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              build-essential \
              ninja-build \
              pkg-config \
              ca-certificates \
              curl \
              nasm \
              yasm \
              linux-libc-dev \
              mesa-common-dev || true

            # Try to install requested toolchain versions if available on the runner
            if [ "$TOOLCHAIN" = "GNU" ]; then
              $SUDO DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends gcc-14 g++-14 || true
            elif [ "$TOOLCHAIN" = "Clang" ]; then
              $SUDO DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends clang-20 || true
            fi
          else
            # no apt-get present; likely a custom container or non-debian distro. Can't auto-install.
            echo "apt-get not available on this runner (likely self-hosted/custom image)."
            echo "Please ensure the following are installed on the runner image:"
            echo "  - ninja-build (ninja)"
            echo "  - a C toolchain (gcc/g++) or clang"
            echo "  - pkg-config"
            echo "  - nasm (and optionally yasm)"
            echo "  - linux-libc-dev (or kernel headers) and mesa-common-dev (if building angle)"
            echo ""
            echo "If you control the runner, on Ubuntu run:"
            echo "  sudo apt-get update"
            echo "  sudo apt-get install -y ninja-build build-essential pkg-config ca-certificates curl nasm yasm linux-libc-dev mesa-common-dev"
            exit 1
          fi

          echo "---- tool availability (post-install check) ----"
          NINJA_PATH="$(which ninja 2>/dev/null || true)"
          echo "which ninja: $NINJA_PATH"
          ninja --version || true
          echo "which gcc: $(which gcc || true)"
          gcc --version | head -n1 || true
          echo "which g++: $(which g++ || true)"
          g++ --version | head -n1 || true
          echo "which clang: $(which clang || true)"
          clang --version | head -n1 || true
          echo "which nasm: $(which nasm || true)"
          nasm --version || true
          echo "which yasm: $(which yasm || true)"
          yasm --version || true

          # Export CMAKE_MAKE_PROGRAM and CC/CXX early so Set Up Environment or any action that runs CMake/vcpkg sees them.
          if [ -n "$NINJA_PATH" ]; then
            echo "CMAKE_MAKE_PROGRAM=$NINJA_PATH" >> "$GITHUB_ENV"
          fi

          # Export default CC/CXX based on requested toolchain to help vcpkg detect compilers early.
          if [ "$TOOLCHAIN" = "GNU" ]; then
            if command -v gcc-14 >/dev/null 2>&1; then
              echo "CC=gcc-14" >> "$GITHUB_ENV"
              echo "CXX=g++-14" >> "$GITHUB_ENV"
            else
              echo "CC=$(which gcc || true)" >> "$GITHUB_ENV"
              echo "CXX=$(which g++ || true)" >> "$GITHUB_ENV"
            fi
          elif [ "$TOOLCHAIN" = "Clang" ]; then
            if command -v clang-20 >/dev/null 2>&1; then
              echo "CC=clang-20" >> "$GITHUB_ENV"
              echo "CXX=clang++-20" >> "$GITHUB_ENV"
            else
              echo "CC=$(which clang || true)" >> "$GITHUB_ENV"
              echo "CXX=$(which clang++ || true)" >> "$GITHUB_ENV"
            fi
          else
            echo "CC=$(which gcc || which clang || true)" >> "$GITHUB_ENV"
            echo "CXX=$(which g++ || which clang++ || true)" >> "$GITHUB_ENV"
          fi
      # ---- end install step ----

      - name: Set Up Environment
        uses: ./.github/actions/setup
        with:
          os: ${{ inputs.os_name }}
          arch: ${{ inputs.arch }}
          toolchain: ${{ inputs.toolchain }}

      - name: Assign Build Parameters
        if: ${{ inputs.os_name != 'Windows' }}
        id: 'build-parameters'
        run: |
          CMAKE_OPTIONS="-DENABLE_CI_BASELINE_CPU=ON"
          if ${{ inputs.toolchain == 'Swift' }} ; then
            echo "host_cc=$(swiftly use --print-location)/usr/bin/clang" >> "$GITHUB_OUTPUT"
            echo "host_cxx=$(swiftly use --print-location)/usr/bin/clang++" >> "$GITHUB_OUTPUT"
            CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_SWIFT=ON"
          elif ${{ inputs.os_name == 'Linux' }} ; then
            if ${{ inputs.toolchain == 'Clang' }} ; then
              echo "host_cc=clang-20" >> "$GITHUB_OUTPUT"
              echo "host_cxx=clang++-20" >> "$GITHUB_OUTPUT"
            elif ${{ inputs.toolchain == 'GNU' }} ; then
              echo "host_cc=gcc-14" >> "$GITHUB_OUTPUT"
              echo "host_cxx=g++-14" >> "$GITHUB_OUTPUT"
            fi
          elif ${{ inputs.os_name == 'macOS' }} ; then
            echo "host_cc=$(xcrun --find clang)" >> "$GITHUB_OUTPUT"
            echo "host_cxx=$(xcrun --find clang++)" >> "$GITHUB_OUTPUT"
          fi

          if ${{ inputs.clang_plugins }} ; then
            echo "ccache_key=${{ inputs.build_preset }}-CLANG_PLUGINS" >> "$GITHUB_OUTPUT"
            CMAKE_OPTIONS="$CMAKE_OPTIONS -DENABLE_CLANG_PLUGINS=ON"
          else
            echo "ccache_key=${{ inputs.build_preset }}" >> "$GITHUB_OUTPUT"
            if ${{ inputs.os_name == 'Linux' && inputs.arch == 'arm64' }} ; then
                # FIXME: https://github.com/WebAssembly/wabt/issues/2533
                #        wabt doesn't have binary releases for arm64 Linux
                PKGCONFIG=$(which pkg-config)
                CMAKE_OPTIONS="$CMAKE_OPTIONS -DPKG_CONFIG_EXECUTABLE=$PKGCONFIG"
            else
              CMAKE_OPTIONS="$CMAKE_OPTIONS -DINCLUDE_WASM_SPEC_TESTS=ON -DWASM_SPEC_TEST_SKIP_FORMATTING=ON"
            fi
          fi

          echo "cmake_options=$CMAKE_OPTIONS" >> "$GITHUB_OUTPUT"

      - name: Restore Caches
        uses: ./.github/actions/cache-restore
        id: 'cache-restore'
        with:
          runner_labels: ${{ inputs.runner_labels }}
          os: ${{ inputs.os_name }}
          arch: ${{ inputs.arch }}
          toolchain: ${{ inputs.toolchain }}
          cache_key_extra: ${{ inputs.os_name == 'Windows' && inputs.build_preset || steps.build-parameters.outputs.ccache_key }}
          ccache_path: ${{ env.CCACHE_DIR }}
          download_cache_path: ${{ github.workspace }}/Build/caches
          vcpkg_cache_path: ${{ github.workspace }}/Build/caches/vcpkg-binary-cache

      - name: Set dynamic environment variables
        if: ${{ inputs.os_name != 'Windows' }}
        run: |
          # Note: Required for vcpkg to use this compiler for its own builds.
          echo "CC=${{ steps.build-parameters.outputs.host_cc }}" >> "$GITHUB_ENV"
          echo "CXX=${{ steps.build-parameters.outputs.host_cxx }}" >> "$GITHUB_ENV"

      - name: Create Build Environment
        if: ${{ inputs.os_name != 'Windows' && inputs.build_preset != 'Fuzzers' }}
        working-directory: ${{ github.workspace }}
        env:
          VCPKG_CACHE_SAS: ${{ github.ref == 'refs/heads/master' && secrets.VCPKG_CACHE_SAS || '' }}
          VCPKG_CACHE_MODE: ${{ github.ref == 'refs/heads/master' && 'write' || '' }}
        run: |
          cmake --preset ${{ inputs.build_preset }} -B Build \
            ${{ steps.build-parameters.outputs.cmake_options }} \
            -DPython3_EXECUTABLE=${{ env.pythonLocation }}/bin/python \
            -DCMAKE_C_COMPILER=${{ steps.build-parameters.outputs.host_cc }} \
            -DCMAKE_CXX_COMPILER=${{ steps.build-parameters.outputs.host_cxx }}

      - name: Create Build Environment (Windows)
        if: ${{ inputs.os_name == 'Windows' }}
        working-directory: ${{ github.workspace }}
        env:
          VCPKG_CACHE_SAS: ${{ github.ref == 'refs/heads/master' && secrets.VCPKG_CACHE_SAS || '' }}
          VCPKG_CACHE_MODE: ${{ github.ref == 'refs/heads/master' && 'write' || '' }}
        run: |
          cmake --preset ${{ inputs.build_preset }} -B Build `
            -DENABLE_CI_BASELINE_CPU=ON

      - name: Create Build Environment (Fuzzers)
        if: ${{ inputs.build_preset == 'Fuzzers' }}
        working-directory: ${{ github.workspace }}
        env:
          VCPKG_CACHE_SAS: ${{ github.ref == 'refs/heads/master' && secrets.VCPKG_CACHE_SAS || '' }}
          VCPKG_CACHE_MODE: ${{ github.ref == 'refs/heads/master' && 'write' || '' }}
        run: |
          cmake --preset=Distribution -S Meta/Lagom -B ${{ github.workspace }}/Build/tools-build \
            -DLAGOM_TOOLS_ONLY=ON \
            -DINSTALL_LAGOM_TOOLS=ON \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/Build/tools-install \
            -DPython3_EXECUTABLE=${{ env.pythonLocation }}/bin/python \
            -Dpackage=LagomTools

          ninja -C ${{ github.workspace }}/Build/tools-build install

          cmake --preset ${{ inputs.build_preset }} -B Build \
            -DPython3_EXECUTABLE=${{ env.pythonLocation }}/bin/python \
            -DCMAKE_C_COMPILER=${{ steps.build-parameters.outputs.host_cc }} \
            -DCMAKE_CXX_COMPILER=${{ steps.build-parameters.outputs.host_cxx }} \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/Build/tools-install

      # === BUILD ===

      - name: Build
        working-directory: ${{ github.workspace }}/Build
        run: |
          cmake --build .
          cmake --install . --strip --prefix ${{ github.workspace }}/Install

      - name: Build - macOS with Qt
        if: ${{ inputs.os_name == 'macOS' && inputs.build_preset == 'Sanitizer' }}
        working-directory: ${{ github.workspace }}
        run: |
          cmake --preset ${{ inputs.build_preset }} -B Build -DENABLE_QT=ON
          cmake --build Build

      - name: Save Caches
        uses: ./.github/actions/cache-save
        with:
          runner_labels: ${{ inputs.runner_labels }}
          arch: ${{ inputs.arch }}
          ccache_path: ${{ env.CCACHE_DIR }}
          ccache_primary_key: ${{ steps.cache-restore.outputs.ccache_primary_key }}
          vcpkg_cache_path: ${{ github.workspace }}/Build/caches/vcpkg-binary-cache
          vcpkg_cache_primary_key: ${{ steps.cache-restore.outputs.vcpkg_cache_primary_key }}

      - name: Test
        if: ${{ contains(inputs.build_preset, 'Sanitizer') }}
        working-directory: ${{ github.workspace }}
        run: ctest --preset ${{ inputs.build_preset }} --output-on-failure --test-dir Build --timeout 1800
        env:
          TESTS_ONLY: 1
          # NOTE: These are appended to the preset's options.
          ASAN_OPTIONS: 'log_path="${{ github.workspace }}/asan.log"'
          UBSAN_OPTIONS: 'log_path="${{ github.workspace }}/ubsan.log"'

      - name: Print vcpkg manifest install log (if present)
        if: failure()
        run: |
          logfile="${{ github.workspace }}/Build/vcpkg-manifest-install.log"
          echo "==== vcpkg-manifest-install.log ===="
          if [ -f "$logfile" ]; then
            sed -n '1,400p' "$logfile" || true
          else
            echo "No $logfile found"
          fi