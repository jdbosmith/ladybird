# SonarQube analysis (updated 2025-12-03)
# - More robust vcpkg bootstrap: checks for repository-provided bootstrap script, falls back to Toolchain/BuildVcpkg.py,
#   then falls back to cloning upstream vcpkg and bootstrapping.
# - Ensures required system packages for vcpkg ports that need assemblers/kernel headers are installed (nasm/yasm/linux-libc-dev).
# - Prints clearer diagnostics on failure.
#
# Keep your SonarQube secrets (SONAR_TOKEN, SONAR_ORG, SONAR_PROJECT_KEY) set in repository settings.

name: SonarQube analysis

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  pull-requests: read

jobs:
  sonarcloud:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            ninja-build \
            clang \
            libssl-dev \
            libx11-dev \
            libxext-dev \
            libxrender-dev \
            libgl1-mesa-dev \
            mesa-common-dev \
            linux-libc-dev \
            nasm \
            yasm \
            python3 \
            python3-venv \
            python3-distutils \
            git \
            curl \
            gcc \
            g++

      - name: Ensure vcpkg is present and bootstrapped
        id: ensure-vcpkg
        run: |
          set -euo pipefail

          echo "=== vcpkg bootstrap helper ==="

          # Prefer an existing bootstrap script in the repo
          if [ -x "./Build/vcpkg/bootstrap-vcpkg.sh" ]; then
            echo "Found Build/vcpkg/bootstrap-vcpkg.sh — running it"
            ./Build/vcpkg/bootstrap-vcpkg.sh
            exit 0
          fi

          echo "No Build/vcpkg/bootstrap-vcpkg.sh found."

          # If repository includes a helper script to build/pin vcpkg, use it
          if [ -f "./Toolchain/BuildVcpkg.py" ]; then
            echo "Found Toolchain/BuildVcpkg.py — invoking it to obtain vcpkg"
            if command -v python3 >/dev/null 2>&1; then
              python3 ./Toolchain/BuildVcpkg.py
            else
              python ./Toolchain/BuildVcpkg.py
            fi

            if [ -x "./Build/vcpkg/bootstrap-vcpkg.sh" ]; then
              echo "vcpkg created successfully by Toolchain/BuildVcpkg.py — bootstrapping"
              ./Build/vcpkg/bootstrap-vcpkg.sh
              exit 0
            else
              echo "Toolchain/BuildVcpkg.py ran but Build/vcpkg/bootstrap-vcpkg.sh is still missing"
            fi
          else
            echo "Toolchain/BuildVcpkg.py not present in the repository"
          fi

          # Fall back to cloning upstream vcpkg (last resort)
          echo "Attempting to clone upstream vcpkg into Build/vcpkg and bootstrap it"
          rm -rf Build/vcpkg || true
          git clone --depth 1 https://github.com/microsoft/vcpkg.git Build/vcpkg || {
            echo "git clone of vcpkg failed"
            exit 1
          }

          if [ -x "./Build/vcpkg/bootstrap-vcpkg.sh" ]; then
            echo "Bootstrapping vcpkg from cloned repository"
            ./Build/vcpkg/bootstrap-vcpkg.sh
            exit 0
          fi

          echo "ERROR: Could not find or create Build/vcpkg/bootstrap-vcpkg.sh. Ensure vcpkg is provided by the repo or Toolchain/BuildVcpkg.py."
          exit 1

      - name: Install vcpkg dependencies
        run: |
          if [ -x "./Build/vcpkg/vcpkg" ]; then
            echo "Using Build/vcpkg/vcpkg to install dependencies"
            ./Build/vcpkg/vcpkg install || ( echo "vcpkg install failed — see above"; exit 1 )
          else
            echo "vcpkg binary not found at Build/vcpkg/vcpkg; aborting"
            exit 1
          fi

      - name: Configure CMake
        run: |
          cmake -B build -GNinja \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/Build/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            .

      - name: Build core Ladybird components
        run: ninja -C build LibWeb LibJS LibGfx LibGUI

      - name: Analyze with SonarQube
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=Tests/**,Meta/**,Libraries/LibJS/Tests/**,Libraries/LibWeb/Tests/**,**/wpt-import/**
            -Dsonar.cfamily.compile-commands=build/compile_commands.json