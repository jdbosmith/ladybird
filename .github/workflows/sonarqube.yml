# SonarQube analysis (updated 2025-12-04)
# - Robust vcpkg bootstrap (repo-provided -> Toolchain/BuildVcpkg.py -> clone upstream)
# - Installs nasm/yasm/linux headers/mesa dev as before
# - Fixes python3-distutils failure on Ubuntu 24.04 by attempting the distro-specific distutils package
#   (python3.<minor>-distutils) and falling back to installing python3-setuptools + python3-pip if needed.

name: SonarQube analysis

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  pull-requests: read

jobs:
  sonarcloud:
    runs-on: ubuntu-latest
    env:
      TRIPLET: x64-linux
      VCPKG_ROOT: ${{ github.workspace }}/Build/vcpkg

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install system dependencies (with Python distutils handling)
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            ninja-build \
            clang \
            libssl-dev \
            libx11-dev \
            libxext-dev \
            libxrender-dev \
            libgl1-mesa-dev \
            mesa-common-dev \
            linux-libc-dev \
            nasm \
            yasm \
            python3 \
            python3-venv \
            python3-pip \
            python3-setuptools \
            git \
            curl \
            gcc \
            g++ \
            || true

          # Ensure distutils is importable. On some Ubuntu images python3-distutils is provided as python3.<minor>-distutils
          if python3 -c "import importlib,sys; importlib.import_module('distutils')" 2>/dev/null; then
            echo "python3.distutils is available"
          else
            echo "python3.distutils not available — trying to install python3.<major>.<minor>-distutils package"
            PYVER=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
            PKG="python${PYVER}-distutils"
            echo "Attempting apt-get install $PKG"
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends "$PKG" || true

            if python3 -c "import importlib,sys; importlib.import_module('distutils')" 2>/dev/null; then
              echo "Successfully installed $PKG and can import distutils"
            else
              echo "Could not install $PKG or distutils still not importable. Installing python3-setuptools and ensuring pip is available as fallback."
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends python3-setuptools python3-pip || true
              # try to ensure pip packages that some scripts rely on are present
              python3 -m pip install --upgrade --user setuptools wheel || true

              if python3 -c "import importlib,sys; importlib.import_module('distutils')" 2>/dev/null; then
                echo "distutils importable after setuptools/pip fallback"
              else
                echo "WARNING: distutils still not importable. Some bootstrap scripts may still fail. Proceeding and hoping Toolchain/BuildVcpkg.py or cloned vcpkg can work without it."
              fi
            fi
          fi

      - name: Ensure vcpkg is present and bootstrapped
        id: ensure-vcpkg
        run: |
          set -euo pipefail

          echo "=== vcpkg bootstrap helper ==="

          # Prefer an existing bootstrap script in the repo
          if [ -x "./Build/vcpkg/bootstrap-vcpkg.sh" ]; then
            echo "Found Build/vcpkg/bootstrap-vcpkg.sh — running it"
            ./Build/vcpkg/bootstrap-vcpkg.sh
            exit 0
          fi

          echo "No Build/vcpkg/bootstrap-vcpkg.sh found."

          # If repository includes a helper script to build/pin vcpkg, use it
          if [ -f "./Toolchain/BuildVcpkg.py" ]; then
            echo "Found Toolchain/BuildVcpkg.py — invoking it to obtain vcpkg"
            if command -v python3 >/dev/null 2>&1; then
              python3 ./Toolchain/BuildVcpkg.py
            else
              python ./Toolchain/BuildVcpkg.py
            fi

            if [ -x "./Build/vcpkg/bootstrap-vcpkg.sh" ]; then
              echo "vcpkg created successfully by Toolchain/BuildVcpkg.py — bootstrapping"
              ./Build/vcpkg/bootstrap-vcpkg.sh
              exit 0
            else
              echo "Toolchain/BuildVcpkg.py ran but Build/vcpkg/bootstrap-vcpkg.sh is still missing"
            fi
          else
            echo "Toolchain/BuildVcpkg.py not present in the repository"
          fi

          # Fall back to cloning upstream vcpkg (last resort)
          echo "Attempting to clone upstream vcpkg into Build/vcpkg and bootstrap it"
          rm -rf Build/vcpkg || true
          git clone --depth 1 https://github.com/microsoft/vcpkg.git Build/vcpkg || {
            echo "git clone of vcpkg failed"
            exit 1
          }

          if [ -x "./Build/vcpkg/bootstrap-vcpkg.sh" ]; then
            echo "Bootstrapping vcpkg from cloned repository"
            ./Build/vcpkg/bootstrap-vcpkg.sh
            exit 0
          fi

          echo "ERROR: Could not find or create Build/vcpkg/bootstrap-vcpkg.sh. Ensure vcpkg is provided by the repo or Toolchain/BuildVcpkg.py."
          exit 1

      - name: Install vcpkg dependencies
        env:
          TRIPLET: ${{ env.TRIPLET }}
        run: |
          set -euo pipefail
          VCPKG_BIN=./Build/vcpkg/vcpkg

          if [ ! -x "${VCPKG_BIN}" ]; then
            echo "vcpkg binary not found at ${VCPKG_BIN}; aborting"
            ls -la Build/vcpkg || true
            exit 1
          fi

          echo "vcpkg version:"
          ${VCPKG_BIN} --version

          # If a manifest is present, prefer manifest install so pins in vcpkg.json are respected.
          if [ -f vcpkg.json ]; then
            echo "Installing vcpkg manifest dependencies (vcpkg.json) for triplet ${TRIPLET}"
            ${VCPKG_BIN} install --triplet ${TRIPLET} || ( echo "vcpkg manifest install failed"; ${VCPKG_BIN} list; exit 1 )
          else
            # Fallback: explicitly install Qt6 ports that LibWeb (and other targets) require.
            # Adjust the list below if your project requires additional Qt ports.
            echo "No vcpkg.json found; installing Qt6 ports explicitly into vcpkg for triplet ${TRIPLET}"
            ${VCPKG_BIN} install qt6-base:${TRIPLET} qt6-webengine:${TRIPLET} || ( echo "vcpkg install of Qt6 ports failed"; ${VCPKG_BIN} list; exit 1 )
          fi

          # Basic diagnostics to ensure Qt6 CMake config files are present for CMake
          echo "vcpkg installed ports:"
          ${VCPKG_BIN} list || true
          echo "Installed cmake config dirs:"
          ls -la Build/vcpkg/installed/${TRIPLET}/lib/cmake || true
          find Build/vcpkg/installed/${TRIPLET} -name "Qt6CoreConfig.cmake" -print || true

      - name: Configure CMake
        run: |
          cmake -B build -GNinja \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/Build/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            .

      - name: Build core Ladybird components
        run: ninja -C build LibWeb LibJS LibGfx LibGUI

      - name: Analyze with SonarQube
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=Tests/**,Meta/**,Libraries/LibJS/Tests/**,Libraries/LibWeb/Tests/**,**/wpt-import/**
            -Dsonar.cfamily.compile-commands=build/compile_commands.json